# Test Account Creation and Password Reset Issues

## Issue Analysis

Based on the reported problems:

1. **Account Creation Fails**: Profile not being saved to Firestore with autogenerated profile ID
2. **Password Reset Not Working**: Forgot password option in login screen doesn't work
3. **Build Cache**: Possible build cache issues after code changes

## Diagnostic Steps

### 1. Check Firebase Firestore Rules
The profile creation might be failing due to Firestore security rules. Let's verify the rules allow profile creation:

```javascript
// Expected Firestore rules (in firestore.rules)
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow profile creation and updates for authenticated users
    match /profiles/{profileId} {
      allow read, write: if request.auth != null;
    }
    
    // Allow documents access for authenticated users
    match /documents/{document} {
      allow read, write: if request.auth != null;
    }
  }
}
```

### 2. Check Firebase Functions Status
Verify Firebase Functions are deployed and accessible:

```bash
# Check function deployment status
firebase functions:list --project fedha-tracker

# Test health endpoint
curl https://africa-south1-fedha-tracker.cloudfunctions.net/health
```

### 3. Account Creation Debug Flow

The account creation follows this flow:
1. `registerWithEmailVerification()` called
2. Tries Firebase Functions `registerWithVerification` first
3. Falls back to `_registerDirectly()` if Functions fail
4. `_registerDirectly()` should:
   - Create Firebase Auth user
   - Create Firestore profile with generated ID
   - Link Firebase UID to profile
   - Auto-login user

### 4. Password Reset Debug Flow

The password reset follows this flow:
1. User clicks "Forgot Password?" in login screen
2. `_showForgotPassword()` shows dialog
3. User enters email and clicks "Send Reset Email"
4. `_handlePasswordReset()` calls `enhancedAuthService.resetPassword()`
5. `resetPassword()` calls Firebase Auth `sendPasswordResetEmail()`

## Common Issues and Solutions

### Issue 1: Firestore Permission Denied
**Symptoms**: Profile creation fails with permission errors
**Solution**: Update Firestore rules to allow authenticated users to create profiles

### Issue 2: Firebase Functions Not Accessible
**Symptoms**: Registration tries Functions first but they're not deployed/accessible
**Solution**: Ensure Functions are deployed to correct region (africa-south1)

### Issue 3: Build Cache Issues
**Symptoms**: Code changes not reflected, dependencies not recognized
**Solution**: 
```bash
flutter clean
flutter pub get
flutter build apk --debug
```

### Issue 4: Firebase Auth User Exists But No Profile
**Symptoms**: Users can authenticate but no profile in Firestore
**Solution**: Check if `_registerDirectly()` method is creating profiles correctly

### Issue 5: Password Reset Email Domain Issues
**Symptoms**: Password reset emails not sent or not received
**Solution**: Verify Firebase Auth is configured correctly for fedha-tracker.firebaseapp.com

## Testing Plan

1. **Manual Registration Test**:
   - Create new account through profile creation screen
   - Verify Firebase Auth user is created
   - Verify Firestore profile is created with correct ID
   - Verify auto-login works

2. **Manual Password Reset Test**:
   - Use existing account email
   - Click "Forgot Password?" in login screen
   - Enter email and submit
   - Check for success/error messages
   - Verify email is received

3. **Debug Logging**:
   - Enable detailed logging in enhanced auth service
   - Monitor Firestore write operations
   - Check Firebase Auth user creation
   - Verify profile ID generation and saving

## Expected Results

After fixing the issues:
- ✅ Account creation should create both Firebase Auth user and Firestore profile
- ✅ Auto-login should work after registration
- ✅ Password reset should send emails successfully
- ✅ Users should be able to login after account creation
- ✅ Profile data should be accessible in dashboard

## Next Steps

1. Clean build and verify dependencies
2. Check Firestore rules and update if needed
3. Test account creation with detailed logging
4. Test password reset functionality
5. Verify Firebase Functions deployment status
